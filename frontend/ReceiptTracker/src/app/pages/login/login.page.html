<ion-content class="login-content">
  <div class="login-container">
    <div class="login-form-wrapper">
      <div class="login-header">
        <ion-icon name="receipt-outline" class="login-icon"></ion-icon>
        <h1 class="login-title">{{ isLoginMode ? 'Bejelentkezés' : 'Regisztráció' }}</h1>
      </div>
      
      <!-- Login Form -->
      <form *ngIf="isLoginMode" [formGroup]="loginForm" (ngSubmit)="submit()">
        <div class="form-content">
          <!-- Biometric Login Button (if available and credentials exist) -->
          <div *ngIf="biometricAvailable && hasBiometricCredentials" class="biometric-section">
            <ion-button
              expand="block"
              fill="outline"
              color="secondary"
              (click)="biometricLogin()"
              [disabled]="loading$ | async">
              <ion-icon [name]="getBiometricIcon()" slot="start"></ion-icon>
              Bejelentkezés {{ biometricTypeDisplayName }}sal
            </ion-button>

            <div class="divider">
              <span>vagy</span>
            </div>
          </div>

          <!-- Traditional Login Form -->
          <ion-item>
            <ion-label position="floating">Felhasználónév</ion-label>
            <ion-input formControlName="username" type="text" required></ion-input>
          </ion-item>
          <ion-item>
            <ion-label position="floating">Jelszó</ion-label>
            <ion-input formControlName="password" type="password" required></ion-input>
          </ion-item>

          <!-- Enable Biometric Option -->
          <ion-item *ngIf="biometricAvailable && !hasBiometricCredentials">
            <ion-checkbox
              slot="start"
              [(ngModel)]="enableBiometricAfterLogin"
              (ionChange)="onEnableBiometricChange($event)">
            </ion-checkbox>
            <ion-label>{{ biometricTypeDisplayName }} engedélyezése a jövőben</ion-label>
          </ion-item>

          <div *ngIf="biometricAvailable && hasBiometricCredentials" class="biometric-management">
            <ion-button
              fill="clear"
              size="small"
              color="medium"
              (click)="showBiometricSetupAlert()">
              <ion-icon name="checkmark" slot="start"></ion-icon>
              {{ biometricTypeDisplayName }} beállítva
            </ion-button>
          </div>

          <div *ngIf="error$ | async as error" class="error">{{ error }}</div>

          <ion-button expand="block" type="submit" class="login-button" [disabled]="loginForm.invalid || (loading$ | async)">
            <ng-container *ngIf="loading$ | async; else loginText">
              <ion-spinner name="crescent"></ion-spinner>
            </ng-container>
            <ng-template #loginText>Bejelentkezés</ng-template>
          </ion-button>
        </div>
      </form>

      <!-- Registration Form -->
      <form *ngIf="!isLoginMode" [formGroup]="registerForm" (ngSubmit)="submit()">
        <div class="form-content">
          <ion-item>
            <ion-label position="floating">Felhasználónév</ion-label>
            <ion-input formControlName="username" type="text" required></ion-input>
          </ion-item>
          <div *ngIf="registerForm.get('username')?.invalid && registerForm.get('username')?.touched" class="validation-error">
            <span *ngIf="registerForm.get('username')?.errors?.['required']">A felhasználónév kötelező</span>
            <span *ngIf="registerForm.get('username')?.errors?.['minlength']">A felhasználónévnek legalább 3 karakter hosszúnak kell lennie</span>
          </div>
          
          <ion-item>
            <ion-label position="floating">Email (opcionális)</ion-label>
            <ion-input formControlName="email" type="email"></ion-input>
          </ion-item>
          <div *ngIf="registerForm.get('email')?.invalid && registerForm.get('email')?.touched" class="validation-error">
            <span *ngIf="registerForm.get('email')?.errors?.['email']">Érvénytelen email cím</span>
          </div>
          
          <ion-item>
            <ion-label position="floating">Teljes név (opcionális)</ion-label>
            <ion-input formControlName="fullname" type="text"></ion-input>
          </ion-item>
          
          <ion-item>
            <ion-label position="floating">Jelszó</ion-label>
            <ion-input formControlName="password" type="password" required></ion-input>
          </ion-item>
          <div *ngIf="registerForm.get('password')?.invalid && registerForm.get('password')?.touched" class="validation-error">
            <span *ngIf="registerForm.get('password')?.errors?.['required']">A jelszó kötelező</span>
            <span *ngIf="registerForm.get('password')?.errors?.['minlength']">A jelszónak legalább 6 karakter hosszúnak kell lennie</span>
          </div>
          
          <ion-item>
            <ion-label position="floating">Jelszó megerősítése</ion-label>
            <ion-input formControlName="confirmPassword" type="password" required></ion-input>
          </ion-item>
          <div *ngIf="registerForm.get('confirmPassword')?.invalid && registerForm.get('confirmPassword')?.touched" class="validation-error">
            <span *ngIf="registerForm.get('confirmPassword')?.errors?.['required']">A jelszó megerősítése kötelező</span>
          </div>

          <div *ngIf="registerForm.errors?.['passwordMismatch'] && registerForm.get('confirmPassword')?.touched" class="validation-error">
            <span>A jelszavak nem egyeznek</span>
          </div>

          <div *ngIf="error$ | async as error" class="error">{{ error }}</div>

          <ion-button expand="block" type="submit" class="login-button" [disabled]="registerForm.invalid || (loading$ | async)">
            <ng-container *ngIf="loading$ | async; else registerText">
              <ion-spinner name="crescent"></ion-spinner>
            </ng-container>
            <ng-template #registerText>Regisztráció</ng-template>
          </ion-button>
        </div>
      </form>

      <!-- Toggle between login and register -->
      <div class="toggle-section">
        <ion-button
          fill="clear"
          size="small"
          color="medium"
          (click)="toggleMode()">
          {{ isLoginMode ? 'Nincs még fiókja? Regisztráljon!' : 'Már van fiókja? Jelentkezzen be!' }}
        </ion-button>
      </div>
    </div>
  </div>

  <!-- Success Toast -->
  <ion-toast
    [isOpen]="showSuccessToast"
    [message]="toastMessage"
    duration="3000"
    color="success"
    (didDismiss)="showSuccessToast = false">
  </ion-toast>

  <!-- Error Toast -->
  <ion-toast
    [isOpen]="showErrorToast"
    [message]="toastMessage"
    duration="3000"
    color="danger"
    (didDismiss)="showErrorToast = false">
  </ion-toast>

  <!-- Biometric Management Alert -->
  <ion-alert
    [isOpen]="showBiometricAlert"
    header="Biometrikus azonosítás"
    [message]="'A ' + biometricTypeDisplayName + ' már be van állítva ezen az eszközön.'"
    [buttons]="biometricAlertButtons"
    (didDismiss)="showBiometricAlert = false">
  </ion-alert>
</ion-content>
