<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Statisztikák</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Szűrők -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Szűrők</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <ion-range
          [min]="MIN_DATE"
          [max]="MAX_DATE"
          [value]="{ lower: dateRange()[0], upper: dateRange()[1] }"
          [dualKnobs]="true"
          (ionInput)="onDateRangeInput($event)"
          (ionChange)="onDateRangeChange($event)"
          style="flex: 1 1 300px; max-width: 400px;"
        >
        </ion-range>
        <div style="min-width: 180px; text-align: center; font-size: 0.95em;">
          <span>{{ dateRange() && (dateRange()[0] | date:'yyyy.MM.dd') }}</span>
          &ndash;
          <span>{{ dateRange() && (dateRange()[1] | date:'yyyy.MM.dd') }}</span>
        </div>
        
        <!-- User filter (admin only) -->
        <ion-select 
          *ngIf="isAdmin()" 
          interface="popover" 
          placeholder="Felhasználó" 
          [formControl]="userId"
          (ionChange)="onUserChange()"
        >
          <ion-select-option [value]="null">Összes felhasználó</ion-select-option>
          <ion-select-option *ngFor="let user of users$ | async" [value]="user.id">{{user.fullname || user.username}}</ion-select-option>
        </ion-select>
        
        <ion-button color="medium" fill="outline" (click)="clearFilters()" type="button">
          Szűrők törlése
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- KPI Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <ion-card color="primary">
      <ion-card-header>
        <ion-card-title>Összesen elköltött</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="totalSpent$ | async as totalSpent; else loadingSpent">
          <div style="font-size: 2rem; font-weight: bold; text-align: center;">
            {{ totalSpent.total_spent | number:'1.0-0' }} Ft
          </div>
        </ng-container>
        <ng-template #loadingSpent>
          <ion-spinner style="display: block; margin: 1rem auto;"></ion-spinner>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <ion-card color="secondary">
      <ion-card-header>
        <ion-card-title>Vásárlások száma</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="totalReceipts$ | async as totalReceipts; else loadingReceipts">
          <div style="font-size: 2rem; font-weight: bold; text-align: center;">
            {{ totalReceipts.total_receipts }}
          </div>
        </ng-container>
        <ng-template #loadingReceipts>
          <ion-spinner style="display: block; margin: 1rem auto;"></ion-spinner>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <ion-card color="tertiary">
      <ion-card-header>
        <ion-card-title>Átlagos blokk érték</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="averageReceiptValue$ | async as avgValue; else loadingAvg">
          <div style="font-size: 2rem; font-weight: bold; text-align: center;">
            {{ avgValue.average_receipt_value | number:'1.0-0' }} Ft
          </div>
        </ng-container>
        <ng-template #loadingAvg>
          <ion-spinner style="display: block; margin: 1rem auto;"></ion-spinner>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>

  <!-- Charts -->
  <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
    <!-- Vásárlások időbeli alakulása -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Vásárlások időbeli alakulása</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div id="receipts-chart" style="width: 100%; height: 300px;"></div>
      </ion-card-content>
    </ion-card>

    <!-- Összeg időbeli alakulása -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Elköltött összeg időbeli alakulása</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div id="amounts-chart" style="width: 100%; height: 300px;"></div>
      </ion-card-content>
    </ion-card>

    <!-- Szófelhő -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Leggyakrabban vásárolt termékek</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="wordcloudData$ | async as wordcloudData; else loadingWordcloud">
          <div style="width: 100%; height: 400px;">
            <!-- Itt jönne a szófelhő megjelenítés -->
            <div style="display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 0.5rem; padding: 1rem;">
              <span *ngFor="let item of wordcloudData" 
                    style="font-size: 12px; padding: 0.2rem 0.5rem; border-radius: 4px; background: rgba(var(--ion-color-primary-rgb), 0.1); color: var(--ion-color-primary);">
                {{ item.text }}
              </span>
            </div>
          </div>
        </ng-container>
        <ng-template #loadingWordcloud>
          <div style="width: 100%; height: 400px; display: flex; align-items: center; justify-content: center;">
            <ion-spinner></ion-spinner>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>

    <!-- Top termékek lista -->
    <ion-card>
      <ion-card-header>
        <ion-card-title>Top 10 termék</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <ng-container *ngIf="topItems$ | async as topItems; else loadingTopItems">
          <ion-list>
            <ion-item *ngFor="let item of topItems.items; let i = index">
              <ion-label>
                <h3>{{ i + 1 }}. {{ item.name }}</h3>
                <p>{{ item.count }}x vásárolva</p>
              </ion-label>
              <ion-note slot="end">{{ item.total_spent | number:'1.0-0' }} Ft</ion-note>
            </ion-item>
          </ion-list>
        </ng-container>
        <ng-template #loadingTopItems>
          <div style="display: flex; align-items: center; justify-content: center; padding: 2rem;">
            <ion-spinner></ion-spinner>
          </div>
        </ng-template>
      </ion-card-content>
    </ion-card>
  </div>
</ion-content> 