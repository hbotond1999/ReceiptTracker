<ion-header>
  <ion-toolbar color="primary">
    <ion-title>Statisztikák</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Szűrők -->
  <ion-card>
    <ion-card-header>
      <ion-card-title>Szűrők</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        <!-- Csak kézi dátum inputok -->
        <ion-item style="min-width: 150px;">
          <ion-label position="stacked">Kezdő dátum</ion-label>
          <ion-input
            type="date"
            [formControl]="dateFrom"
            placeholder="Kezdő dátum"
            (ionInput)="onDateFromChange($event)">
          </ion-input>
        </ion-item>
        <ion-item style="min-width: 150px;">
          <ion-label position="stacked">Záró dátum</ion-label>
          <ion-input
            type="date"
            [formControl]="dateTo"
            placeholder="Záró dátum"
            (ionInput)="onDateToChange($event)">
          </ion-input>
        </ion-item>

        <!-- User filter (admin only) -->
        <ion-select
          *ngIf="isAdmin()"
          interface="popover"
          placeholder="Felhasználó"
          [formControl]="userId"
          (ionChange)="onUserChange()"
        >
          <ion-select-option [value]="null">Összes felhasználó</ion-select-option>
          <ion-select-option *ngFor="let user of users$ | async" [value]="user.id">{{user.fullname || user.username}}</ion-select-option>
        </ion-select>

        <!-- Aggregation type filter -->
        <ion-select
          interface="popover"
          placeholder="Nézet típus"
          [formControl]="aggregationType"
          (ionChange)="onAggregationTypeChange()"
        >
          <ion-select-option *ngFor="let option of aggregationTypeOptions" [value]="option.value">
            {{option.label}}
          </ion-select-option>
        </ion-select>

        <ion-button color="medium" fill="outline" (click)="clearFilters()" type="button">
          Szűrők törlése
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <!-- KPI Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <app-kpi-card
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      kpiType="totalSpent"
      title="Összesen elköltött"
      color="primary"
      unit="Ft">
    </app-kpi-card>

    <app-kpi-card
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      kpiType="totalReceipts"
      title="Vásárlások száma"
      color="secondary">
    </app-kpi-card>

    <app-kpi-card
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      kpiType="averageReceiptValue"
      title="Átlagos blokk érték"
      color="tertiary"
      unit="Ft">
    </app-kpi-card>
  </div>

  <!-- Charts -->
  <div style="display: grid; grid-template-columns: 1fr; gap: 2rem;">
    <!-- Vásárlások időbeli alakulása -->
    <app-receipts-chart
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      [aggregationType]="chartAggregationType()">
    </app-receipts-chart>

    <!-- Összeg időbeli alakulása -->
    <app-amounts-chart
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      [aggregationType]="chartAggregationType()">
    </app-amounts-chart>

    <!-- Összköltés boltonként -->
    <app-market-total-spent-chart
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()">
    </app-market-total-spent-chart>

    <!-- vásárlások száma boltonként -->
    <app-market-total-receipts-chart
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()">
    </app-market-total-receipts-chart>

    <!-- ÚJ: Átlagos költés boltonként -->
    <app-market-average-spent-chart
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()">
    </app-market-average-spent-chart>

    <!-- Top termékek lista -->
    <app-top-items
      [dateFrom]="chartDateFrom()"
      [dateTo]="chartDateTo()"
      [userId]="chartUserId()"
      [limit]="10">
    </app-top-items>
  </div>
</ion-content>
